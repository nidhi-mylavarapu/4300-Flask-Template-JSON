<!doctype html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">

<body>
    <div class="full-body-container">
        <div class="top-text">
            <div class="google-colors">
                <h1 id="google-3">ðŸŽ¥ mediaverse ðŸŽ¥</h1>
            </div>
            <div class="input-box-container">
                <div class="input-box" onclick="sendFocus()" style="position: relative;">
                    <img src="{{ url_for('static', filename='images/mag.png') }}" />
                    <input placeholder="Input Liked Genres" id="filter-text-val-liked">
                    <div id="suggestions-liked" class="suggestions-dropdown"></div>
                </div>
                <div class="input-box" onclick="sendFocus()" style="position: relative;">
                    <img src="{{ url_for('static', filename='images/mag.png') }}" />
                    <input placeholder="Input Disliked Genres" id="filter-text-val-disliked">
                    <div id="suggestions-disliked" class="suggestions-dropdown"></div>
                </div>
                <div class="input-box" onclick="sendFocus()" style="position: relative;">
                    <img src="{{ url_for('static', filename='images/mag.png') }}" />
                    <input placeholder="Input Query/Keywords" id="query-keywords">
                    <div id="suggestions-query" class="suggestions-dropdown"></div>
                </div>
                <button id="search-button" class="enter-btn" type="button">Enter</button>
            </div>
        </div>
        <div class="slider-container">
            <label for="ratingSlider">Rating: <span id="sliderValue">2.5</span>/5.0</label>
            <input type="range" id="ratingSlider" name="rating" min="0.0" max="5.0" value="2.5" step="0.1"
                oninput="updateSliderValue(this.value)">
        </div>

        <div id="answer-box">

        </div>
    </div>
</body>

<script>
    // Function to handle genre selection from suggestions
    function selectGenre(value, dropdownId) {
        document.getElementById(dropdownId.replace('suggestions-', 'filter-text-val-')).value = value;
        document.getElementById(dropdownId).style.display = 'none';
    }

    // Function to show genre suggestions
    function showSuggestions(value, dropdownId) {
        if (value.length === 0) {
            document.getElementById(dropdownId).innerHTML = '';
            document.getElementById(dropdownId).style.display = 'none';
            return;
        }
        fetch("/genre_suggestions?" + new URLSearchParams({query: value}))
            .then(response => response.json())
            .then(data => {
                let suggestions = data.map(genre => {
                    return `<div onclick="event.stopPropagation(); selectGenre('${genre}', '${dropdownId}')">${genre}</div>`;
                }).join('');
                document.getElementById(dropdownId).innerHTML = suggestions;
                document.getElementById(dropdownId).style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching genre suggestions:', error);
            });
    }

    document.getElementById('filter-text-val-liked').addEventListener('input', function() {
        showSuggestions(this.value, 'suggestions-liked');
    });

    document.getElementById('filter-text-val-disliked').addEventListener('input', function() {
        showSuggestions(this.value, 'suggestions-disliked');
    });

    function displayMovies(movies) {
        const movies_json = JSON.parse(movies);
        const answerBox = document.getElementById("answer-box");
        answerBox.innerHTML = "";
        movies_json.forEach(movie => {
            let movieElement = document.createElement("div");
            movieElement.innerHTML = answerBoxTemplate(movie.title, movie.overview, movie.popularity, movie.poster_path);
            answerBox.appendChild(movieElement);
        });
    }

    // Template for displaying each movie
    function answerBoxTemplate(title, description, popularity, posterPath) {
        const placeholderImage = posterPath ? `http://image.tmdb.org/t/p/w185${posterPath}` : '/static/images/sample_poster.png';
        return `<div class='answer-content'>
                    <div class='text-content'>
                        <h3 class='movie-title'>${title}</h3>
                        <p class='movie-desc'>${description}</p>
                        <p class='movie-rating'>Popularity: ${popularity}</p>
                    </div>
                    <img src='${placeholderImage}' alt='Movie Poster' class='movie-image'/>
                </div>`;
    }

    document.getElementById('search-button').addEventListener('click', function() {
        const likedGenres = document.getElementById('filter-text-val-liked').value;
        const dislikedGenres = document.getElementById('filter-text-val-disliked').value;

        fetch(`/predict_preference?liked_genres=${encodeURIComponent(likedGenres)}&disliked_genres=${encodeURIComponent(dislikedGenres)}`)
            .then(response => response.json())
            .then(data => {
                console.log('Preference data:', data);
                if (data.error) {
                    console.error('Error in predict_preference:', data.error);
                    return;
                }
                fetch(`/recommended_movies?like_probability=${data.like_probability}`)
                    .then(response => response.text())
                    .then(text => {
                        console.log("Raw text received:", text);
                        try {
                            const movies = JSON.parse(text);
                            displayMovies(movies);
                        } catch (e) {
                            console.error('Failed to parse movies as JSON:', e);
                        }
                    })
                    .catch(error => console.error('Failed to load movies:', error));
            })
            .catch(error => console.error('Failed to predict preferences:', error));
    });
</script>

</body>